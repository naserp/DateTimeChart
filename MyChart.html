<!DOCTYPE "html">
<html>
<head>
    <title>DateTimeChart d3</title>
    <style type="text/css" media="screen">
        text
        {
            font-family: Arial;
            font-size: 9pt;
        }
    </style>
    <link href="Style.css" rel="stylesheet" type="text/css" />

    <script src="d3.js" type="text/javascript"></script>

    <script src="DateTimeChart.js" type="text/javascript"></script>

</head>
<body onkeypress="return keypressed(event);">
 

    <table nowrap="nowrap" width="980" cellspacing="0">
        <tr>
            <td>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </td>
            <td id="tdYear" class="labelSel" align="center" style="width: 100%">
                <label id="LabelDate" style="font-weight: bold">
                </label>
            </td>
            <td>
                &nbsp;
            </td>
            <td class="buttons">
                <button type="button" class="positive" onclick="previous();">
                    <
                </button>
            </td>
            <td class="buttons">
                <button type="button" class="positive" onclick="next();">
                    >
                </button>
            </td>
            <td>
                &nbsp;
            </td>
            <td class="buttons" nowrap="nowrap">
                <button id="buttonDay" type="button" class="positive" onclick="btnDay();">
                    Day
                </button>
            </td>
            <td class="buttons" nowrap="nowrap">
                <button id="buttonMonth" type="button" class="positive" onclick="btnMonth(currentmonthpage);">
                    Month
                </button>
            </td>
            <td class="buttons" nowrap="nowrap">
                <button id="buttonYear" type="button" class="positive" onclick="btnYear(currentyearpage);">
                    Year
                </button>
            </td>
            <td>
                &nbsp;&nbsp;&nbsp;&nbsp;
            </td>
        </tr>

    </table>

    <div id="canvas" style="position:relative;" onmousedown="dragStart(event,'canvas')">
    </div>
          
    <br/>

    <script type="text/javascript" charset="utf-8">
    var activeStatus = 'year';
   	var month_name = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

 
    function myObj(y,m,d,th,tm,v) {
      this.year = y;
      this.month = m;
      this.day = d;
      this.hour = th;
      this.minute = tm;
      this.value = v;
    }

    var intervalX;
    
    var valuelist = new Array();
    var valuelistYear = new Array();
    var valuelistYearN = new Array();
    var valuelistMonth = new Array();
    var valuelistMonthN = new Array();
    var valuelistDay = new Array();
    var valuelistDayN = new Array();

    var yearXLabels = new Array();
    var monthXLabels = new Array();
    var dayXLabels = new Array();
    
    var minyear = 0;
    var maxyear = 0;
    var maxyearpage = 0;
    var currentyearpage = 0;
    var ystep = 0;
    
    var minmonth = 0;
    var maxmonth = 0;
    var maxmonthpage = 0;
    var currentmonthpage = 1;
    var mstep = 0;
    
    randomGen2(valuelist, 500);
    districtArray(valuelist);
    normalize(valuelistYearN);
    normalize(valuelistMonthN);
    
    function randomGen2(array , count){
        for(var i=0;i<count;i++) {
        	var tempyear = 2008 + Math.floor(Math.random() * 3);
        	var tempmonth = Math.floor(Math.random() * 12);
        	var tempday = Math.floor(Math.random() * 31);
        	var temphour = Math.floor(Math.random() * 24);
        	var tempminute = Math.floor(Math.random() * 60);
        	var tempvalue = Math.floor(Math.random() * 11);
	        array[i] = new myObj(tempyear,tempmonth,tempday,temphour,tempminute,tempvalue);
        };
    } 
    
    function districtArray(array) {
    	array.sort(function(a, b) {
    		return b.minute - a.minute;
    	});    	
    	array.sort(function(a, b) {
    		return b.hour - a.hour;
    	});    	
    	array.sort(function(a, b) {
    		return b.day - a.day;
    	});
    	array.sort(function(a, b) {
    		return b.month - a.month;
    	});
    	array.sort(function(a, b) {
    		return b.year - a.year;
    	});
    	
    	maxyear = array[0].year;
    	year = maxyear;
    	var indexYear = 0;
    	var lastyear = maxyear + 1;

    	maxmonth = 12;
    	month = maxmonth-1;	    	
    	var indexMonth = 0;
    	var lastmonth = maxmonth + 1;

    	
    	for(var i=0; i<array.length;i++) {
    		if(array[i].year == lastyear){
    			tempyearindex = Math.abs((array[i].month) - 11) + (maxyearpage-1)*12; 
    			valuelistYear[tempyearindex].value += array[i].value; 
    			valuelistYearN[tempyearindex].value += array[i].value;

    			tempmonthindex = Math.abs((array[i].day) - 30) + (tempyearindex) * 31;
    			valuelistMonth[tempmonthindex].value += array[i].value; 
    			valuelistMonthN[tempmonthindex].value += array[i].value;
    	    }
    		else{
    			maxyearpage++;
    			i--;
    			lastyear--;
    			for(var y=11; y>=0 ; y-- ) {
    				valuelistYear[indexYear] = new myObj(lastyear, y ,0,0,0,0);
    				valuelistYearN[indexYear++] = new myObj(lastyear, y ,0,0,0,0);
    				for(var m=30; m>=0 ; m-- ) {
    					maxmonthpage++;
    				    valuelistMonth[indexMonth] = new myObj(lastyear, y ,m,0,0,0);
    				    valuelistMonthN[indexMonth++] = new myObj(lastyear, y ,m,0,0,0);
    		        }
    		    }	
    	    }
    	}
    	minyear = lastyear;
    }
    
    function normalize(array) {
    	var max = 0;
    	for(var j=0; j<array.length;j++) {
    		if(array[j].value > max)
    			max = array[j].value;
    	}
    	for(var i=0; i< array.length;i++) {
    		var temp = (array[i].value * 10) / max;
    		array[i].value = Math.round(temp *1000)/1000;
    	}
    }       

    var chart = new DateTimeChart(1000, 250, 40, 25,10);
    currentyearpage = 1;
    btnYear(currentyearpage);   	
   	
   	function nextStep() {
    	if(activeStatus == 'day') {
    		if(day < 31) {
    	    	btnDay();
                document.getElementById('LabelDate').textContent = (++day) + " " + month_name[month]+" "+ year;
    		}
    		else {
    			day = 1;
    	    	btnDay();
                document.getElementById('LabelDate').textContent = (day) + " " + month_name[++month]+" "+ year;
    		}
    		
    	}
    	else if(activeStatus == 'month') {
    		var bound = (currentmonthpage-1) * 31 + mstep;
    		if(bound > 0) 
    		{
    			mstep--;
    			if(mstep == -1) {
    				currentmonthpage--;
    				month++;
    				mstep = 30;
    			}
    			btnMonth(currentmonthpage);
    		}
    		else {
    			dragStop();
    		}
    	}
    	else if(activeStatus == 'year') {
    		var bound = (currentyearpage-1) * 12 + ystep;
    		if(bound > 0) 
    		{
    			ystep--;
    			if(ystep == -1) {
    				currentyearpage--;
    				year++;
    				ystep = 11;
    			}
    			btnYear(currentyearpage);
    		}
    		else {
    			dragStop();
    		}
    	}
    }
    
    function previousStep() {
    	if(activeStatus == 'day') {
    		if(day > 1) {
    			btnDay();
                document.getElementById('LabelDate').textContent = (--day) + " " + month_name[month]+" "+ year;
    		}
    		else {
    			day = 31;
    	    	btnDay();
                document.getElementById('LabelDate').textContent = (day) + " " + month_name[--month]+" "+ year;
    		}
    	}
    	else if(activeStatus == 'month') {
    		var bound = (currentmonthpage-1) * 31 + mstep;
    		if(bound < (currentmonthpage*31) && currentmonthpage<maxmonthpage) 
    		{
    			mstep++;
    			if(mstep >= 31) {
    				currentmonthpage++;
    				month--;
    				mstep = 0;
    			}
    			btnMonth(currentmonthpage);
    		}
    		else {
    			dragStop();
    		}
    	}
    	else if(activeStatus == 'year') {
    		var bound = (currentyearpage-1) * 12 + ystep;
    		if(bound < (currentyearpage*12) && currentyearpage<maxyearpage) 
    		{
    			ystep++;
    			if(ystep == 12) {
    				currentyearpage++;
    				year--;
    				ystep = 0;
    			}
    			btnYear(currentyearpage);
    		}
    		else {
    			dragStop();
    		}
    	}
    }    
    
    
    function btnDay() {
    	activeStatus = 'day';
        var dataDayOriginal = new Array();
        randomGen(dataDayOriginal, 25);
    	chart.setDataDay(dataDayOriginal);
    	document.getElementById('LabelDate').textContent = day + "  " +month_name[month] + "  " +year;
    	document.getElementById('buttonDay').className = "Negative";
    	document.getElementById('buttonMonth').className = "Positive";
    	document.getElementById('buttonYear').className = "Positive";
    }
    
    function btnMonth(mpage) {
    	activeStatus = 'month';
    	intervalX = 30;
        var dataMonth = new Array();
        var dataMonthNorm = new Array();
    	var index = 0;
    	for(var i=(mpage*31-1); i >= (mpage-1)*31  ; i--){
    		dataMonth[index] = valuelistMonth[i+mstep].value;
    		dataMonthNorm[index++] = valuelistMonthN[i+mstep].value;
    	}
    	var indexlabel = 32-mstep;

    	for(var j=0; j<11 ;j++) {
    		if(indexlabel >= 32)
    			indexlabel = ((indexlabel+1)%3)+1;
    		monthXLabels[j] = indexlabel;
    		indexlabel += 3;
    	}
        chart.setDataMonth(dataMonthNorm,dataMonth,monthXLabels,mstep,mpage);
    	if(mstep == 0 || mstep == 31 )
    	    document.getElementById('LabelDate').textContent =  month_name[month] + " " + year;
    	else {
    		document.getElementById('LabelDate').textContent = month_name[month-1] + " - " + month_name[month] + " " + year;
    	}
    	document.getElementById('buttonDay').className = "Positive";
    	document.getElementById('buttonMonth').className = "Negative";
    	document.getElementById('buttonYear').className = "Positive";
    }
    
    function btnYear(ypage) {
    	activeStatus = 'year';
    	intervalX = 83;
    	var dataYear= new Array();
    	var dataYearNorm = new Array();
    	var index = 0;
    	
    	for(var i=(12 * ypage -1); i>=(12 * (ypage-1)); i--) {
    		dataYear[index] = valuelistYear[i+ystep].value;
    		dataYearNorm[index++] = valuelistYearN[i+ystep].value;
    	}    	
    	var indexlabel = 12-ystep;
    	for(var j=0; j<12 ;j++) {
    		if(indexlabel >= 12)
    			indexlabel = 0;
    		yearXLabels[j] = month_name[indexlabel++];
    	}
        chart.setDataYear(dataYearNorm,dataYear,yearXLabels,ystep,ypage);
    	
    	if(ystep == 0 || ystep == 12 )
    	    document.getElementById('LabelDate').textContent =  year;
    	else {
    		document.getElementById('LabelDate').textContent = (year-1) + " - " + year;
    	}
    	document.getElementById('buttonDay').className = "Positive";
    	document.getElementById('buttonMonth').className = "Positive";
    	document.getElementById('buttonYear').className = "Negative";
    }  	
  	
   	function next() {
    	if(activeStatus == 'day') {
    		if(day < 31) {
    	    	btnDay();
                document.getElementById('LabelDate').textContent = (++day) + " " + month_name[month]+" "+ year;
    		}
    		else {
    			day = 1;
    	    	btnDay();
                document.getElementById('LabelDate').textContent = (day) + " " + month_name[++month]+" "+ year;
    		}
    		
    	}
    	else if(activeStatus == 'month') {
    		if(currentmonthpage > 0) {
    			mstep = 0;
    			month++;  			
    			currentmonthpage--;
    			if(month>=12) {
    				month = 0;
    				year++;
    			}
       			btnMonth(currentmonthpage);
    		}
    	}
    	else if(activeStatus == 'year') {
    		if(year < maxyear) {
    			ystep = 0;
    			currentyearpage--;
    			year++;
    			btnYear(currentyearpage);    			
    		}
    	}
    }
    
    function previous() {
    	if(activeStatus == 'day') {
    		if(day > 1) {
    			btnDay();
                document.getElementById('LabelDate').textContent = (--day) + " " + month_name[month]+" "+ year;
    		}
    		else {
    			day = 31;
    	    	btnDay();
                document.getElementById('LabelDate').textContent = (day) + " " + month_name[--month]+" "+ year;
    		}
    	}
    	else if(activeStatus == 'month') {
    		if(currentmonthpage < maxmonthpage) {
    			mstep = 0;
    			month--;
    			currentmonthpage++;
    			if(month<0) {
    				month = 11;
    				year--;
    			}
    			btnMonth(currentmonthpage);    			
    		}
    	}
    	else if(activeStatus == 'year') {
    		if(year > minyear) {
    			ystep = 0;
    		    currentyearpage++;
    			year--;
    			btnYear(currentyearpage);
    		}
    	}
    }   
  
    function randomGen(array , count) {
        for(var i=0;i<count;i++) {
	        array[i] = Math.floor(Math.random() * 11);
        };
        array[2] = 10;
        array[8] = 0;
    }
    
    function keypressed(event) {
        var key;
        if (event.keyCode)
            key = event.keyCode;
        else
            key = event.which;
        if (key == 39) {
        	next();
            return false;
        } else 
        if (key == 37) {
        	previous();
            return false;
        }else 
        if (key == 38) {
    	    if(activeStatus == 'day') {
    	    	btnMonth();
    	    }
    	    else if(activeStatus == 'month') {
    	    	btnYear();
    	    }
    	    else if(activeStatus == 'year') {
    	    	btnDay();
    	    }
            return false;
        }else 
        if (key == 40) {
    	    if(activeStatus == 'day') {
    	    	btnYear();
    	    }
    	    else if(activeStatus == 'month') {
                btnDay();
    	    }
    	    else if(activeStatus == 'year') {
    	    	btnMonth();
    	    }
            return false;
        }
        return true;
    }
    </script>

    <script type="text/javascript">
    
    var dragObj = new Object();
    var subtract;
    
    function dragStart(event, id) {

	    var x, y;
    	if (id)
		    dragObj.elNode = document.getElementById(id);
	    else {
    		dragObj.elNode = event.target;

		    if (dragObj.elNode.nodeType == 3)
			    dragObj.elNode = dragObj.elNode.parentNode;
	    }
    	
        x = event.clientX + window.scrollX;
	    y = event.clientY + window.scrollY;

	    dragObj.cursorStartX = x;
	    dragObj.cursorStartY = y;
	    dragObj.elStartLeft = parseInt(dragObj.elNode.style.left, 10);
	    dragObj.elStartTop = parseInt(dragObj.elNode.style.top, 10);

	    if (isNaN(dragObj.elStartLeft)) dragObj.elStartLeft = 0;
	    if (isNaN(dragObj.elStartTop)) dragObj.elStartTop = 0;

	    dragObj.elNode.style.zIndex = ++dragObj.zIndex;

	    document.addEventListener("mousemove", dragGo, true);
	    document.addEventListener("mouseup", dragStop, true);
	    event.preventDefault();
    	
    	subtract = 0;
    }

    function dragGo(event) {
	    var x = event.clientX + window.scrollX-subtract;
	    	    	
    	if(x-dragObj.cursorStartX > intervalX) {
    		previousStep();
    		subtract += intervalX;
    	}
    	
    	if(x-dragObj.cursorStartX <- intervalX) {
    		nextStep();
    		subtract -= intervalX;
    	}
    }

    function dragStop() {
        document.removeEventListener("mousemove", dragGo,   true);
        document.removeEventListener("mouseup",   dragStop, true);
    }

    </script>

</body>
</html>
